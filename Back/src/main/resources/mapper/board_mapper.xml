<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.fitime.board.BoardDAO">

	<!-- 1) 카테고리별 게시글 목록 조회 -->
	<select id="selectByCategory"
		resultType="com.fitime.dto.BoardDTO">
		SELECT
		board_idx AS boardIdx,
		title,
		content,
		category,
		user_id
		AS userId,
		DATE_FORMAT(reg_date, '%Y-%m-%d %H:%i') AS regDate
		FROM board
		WHERE category = #{category} AND deleted = 0
		ORDER BY reg_date DESC
	</select>

	<!-- 2) 단일 게시글 조회 -->
	<select id="selectById" resultType="com.fitime.dto.BoardDTO">
		SELECT
		board_idx AS boardIdx,
		title,
		content,
		category,
		user_id AS userId,
		DATE_FORMAT(reg_date,
		'%Y-%m-%d %H:%i') AS regDate
		FROM board
		WHERE board_idx = #{boardIdx}
		AND deleted = 0
	</select>

	<!-- 3) 소프트 삭제 -->
	<update id="updateSoftDelete">
		UPDATE board
		SET deleted = 1
		WHERE board_idx =
		#{boardIdx}
	</update>

	<!-- 4) 게시글 삽입 (자동 증가 PK를 BoardDTO.boardIdx에 채워줌) -->
	<insert id="insertBoard" useGeneratedKeys="true"
		keyProperty="boardIdx">
		INSERT INTO board (title, content, category, user_id,
		reg_date, deleted)
		VALUES (#{title}, #{content}, #{category},
		#{userId}, NOW(), 0)
	</insert>

	<!-- 5) 첨부 파일명·URL 삽입 -->
	<insert id="insertFile"
		parameterType="com.fitime.dto.FileImageDTO">
		INSERT INTO file_image (file_name, category, board_idx)
		VALUES (#{fileName}, #{category}, #{boardIdx})
	</insert>

	<!-- 6) 게시글별 파일명 조회 -->
	<select id="selectFileNamesByBoardIdx" resultType="string">
		SELECT
		file_name
		FROM file
		WHERE board_idx = #{boardIdx}
	</select>

	<!-- 7) 페이징 전체 개수 조회 -->
	<select id="selectTotalCount" resultType="int">
		SELECT COUNT(*)
		FROM
		board
		WHERE category = #{pageRequest.category} AND deleted = 0
	</select>

	<!-- 8) 페이징 처리된 게시글 목록 조회 -->
	<select id="selectPagingList"
		resultType="com.fitime.dto.BoardDTO">
		SELECT
		board_idx AS boardIdx,
		title,
		content,
		category,
		user_id
		AS userId,
		DATE_FORMAT(reg_date, '%Y-%m-%d %H:%i') AS regDate
		FROM board
		WHERE category = #{pageRequest.category} AND deleted = 0
		ORDER BY
		reg_date DESC
		LIMIT #{pageRequest.pageNum - 1} * #{pageRequest.size},
		#{pageRequest.size}
	</select>

	<!-- 9) 키워드 검색 -->
	<select id="searchByKeyword"
		resultType="com.fitime.dto.BoardDTO">
		SELECT
		board_idx AS boardIdx,
		title,
		content,
		category,
		user_id
		AS userId,
		DATE_FORMAT(reg_date, '%Y-%m-%d %H:%i') AS regDate
		FROM board
		WHERE (title LIKE CONCAT('%', #{keyword}, '%')
		OR content LIKE
		CONCAT('%', #{keyword}, '%'))
		AND deleted = 0
		ORDER BY reg_date DESC
	</select>

	<select id="read" resultType="com.fitime.dto.BoardDTO">
		SELECT
		board_idx AS boardIdx,
		title,
		content,
		category,
		user_id AS userId,
		DATE_FORMAT(reg_date, '%Y-%m-%d
		%H:%i') AS regDate
		FROM board
		WHERE board_idx = #{boardIdx} AND deleted
		= 0
	</select>

	<update id="update" parameterType="com.fitime.dto.BoardDTO">
		UPDATE board
		SET title =
		#{title}, content = #{content}
		WHERE board_idx = #{boardIdx}
	</update>

	<update id="softDelete" parameterType="int">
		UPDATE board
		SET deleted =
		1
		WHERE board_idx = #{boardIdx}
	</update>

	<insert id="write" parameterType="com.fitime.dto.BoardDTO">
		INSERT INTO board (title,
		content, category, user_id, reg_date)
		VALUES (#{title}, #{content},
		#{category}, #{userId}, now())
	</insert>


</mapper>
